name: Create new realease
#on: [push] # Manual make in Slackware distro

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
    - name: Install fuse, libfuse2 #and libgirepository1.0-dev
      run: |
        sudo apt install fuse libfuse2
        #sudo apt install libgirepository1.0-dev

    - name: Get appimagetool
      run: |
        set -x
        wget https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        ls -lah

    - name: Get Pyhton AppImage
      run: |
        set -x
        wget https://github.com/niess/python-appimage/releases/download/python3.11/python3.11.6-cp311-cp311-manylinux_2_28_x86_64.AppImage
        fileName=$(ls python3*.AppImage)
        chmod +x "$fileName"
        ./"$fileName" --appimage-extract
        ls -lah

    - name: Install MComix and update pip
      run: |
        set -x
        cd squashfs-root/opt/python3*/bin/
        pwd
        ls -lah

        version="3.0.0"

        # https://sourceforge.net/projects/mcomix/files/
        wget https://sourceforge.net/projects/mcomix/files/MComix-$version/mcomix-$version.tar.gz

        tar -xvf mcomix-$version.tar.gz
        rm mcomix-$version.tar.gz

        cd mcomix-$version/

        #../pip3.11 install PyGObject

        ../python3.* -m pip install .

        #cd ../../../../

        #../python3.* -m pip install --upgrade pip

    - name: Make AppImage
      run: |
        version="3.0.0"
        set -x
        cd squashfs-root/
        pwd
        ls -lah

        rm -v python* .DirIcon AppRun

        #find . | grep ".png"
        #find . | grep ".svg"
        cp ./opt/python3*/lib/python3.11/site-packages/mcomix/images/mcomix.png .

        #find . | grep ".desktop"
        cp ./opt/python3*/bin/mcomix-3.0.0/share/applications/mcomix.desktop .
        cat mcomix.desktop

        sed -i "s/Name=MComix/Name=MComix-$version/" mcomix.desktop
        mv mcomix.desktop MComix.desktop
        cat MComix.desktop

        pwd
        ls -lah

        cd ../
        mv AppRun squashfs-root/
        mv README.md squashfs-root/
        ls -lah squashfs-root/

        #rm -r squashfs-root/opt/python3*/bin/mcomix-$version/

        ARCH=x86_64 ./appimagetool-x86_64.AppImage squashfs-root/
        ls -lah

        fileName=$(ls MComix*.AppImage)
        echo "fileName: $fileName"
        fileNameNew=$(echo "$fileName" | sed 's/.AppImage//')
        mv "$fileName" "${fileNameNew}-1_JB.AppImage"
        md5sum "${fileNameNew}-1_JB.AppImage" > "${fileNameNew}-1_JB.AppImage.md5"
        ls -lah

    # Build - Error: Resource not accessible by integration
    # Change Settings -> Actions -> General -> Workflow Permissions to allow read and write:
    # https://github.com/actions/first-interaction/issues/10#issuecomment-1506118886

    # https://github.com/marketplace/actions/upload-to-github-release
    - uses: xresloader/upload-to-github-release@main
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          file: "MComix*.AppImage; MComix*.md5"
          #delete_file: "random-name-*.txt;random-*.txt"
          release_id: ${{ steps.create_release.outputs.id }}
          #overwrite: true
          verbose: true
          #tags: true
          draft: false
